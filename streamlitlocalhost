import streamlit as st
from ultralytics import YOLO
import PIL.Image
import time
from datetime import datetime
import hashlib
import pandas as pd

# Setup model - cached to prevent reloading on every rerun
@st.cache_resource
def load_model():
    return YOLO('yolo11n.pt') 

model = load_model()

# Session state setup
if 'counts' not in st.session_state:
    st.session_state.counts = {"bottle": 0, "cup": 0, "can": 0, "food": 0}
if 'points' not in st.session_state:
    st.session_state.points = 0
if 'last_processed_photo' not in st.session_state:
    st.session_state.last_processed_photo = None
if 'last_msg' not in st.session_state:
    st.session_state.last_msg = None

# Sustainability logic
SUSTAINABILITY_LOG = {
    "bottle": {"name": "PET Plastic", "co2_kg": 1.7, "points": 10, "bin": "BLUE/GREEN (Recyclable)", "tip": "Rinse before disposal!"},
    "cup": {"name": "General Waste", "co2_kg": -0.5, "points": -20, "bin": "BLACK (General Waste)", "tip": "Used tissues & soiled items go here."},
    "can": {"name": "Aluminum", "co2_kg": 11.5, "points": 10, "bin": "BLUE/GREEN (Recyclable)", "tip": "Empty and rinse to avoid contamination."},
    "food": {"name": "Organic Waste", "co2_kg": 0.9, "points": 10, "bin": "BROWN (Organic)", "tip": "Diverted for composting!"}
}

FOOD_LABELS = ["apple", "banana", "orange", "sandwich", "broccoli", "carrot"]

# Page config
st.set_page_config(page_title="Izza EcoLens AI - DMU Dubai", layout="wide", page_icon="â™»ï¸")
st.title("â™»ï¸ Izza EcoLens: DMU Dubai Smart Campus")
st.info("ðŸ›ï¸ **Regulatory Alignment:** Metrics calibrated according to the **2026 UAE Federal Decree-Law No. 11**, supporting the national **75% Landfill Diversion Target**.")

# Camera input
col_left, col_mid, col_right = st.columns([1, 2, 1])
with col_mid:
    img_file = st.camera_input("Scan item for Verified DMU Credits")

    if st.session_state.last_msg:
        st.success(st.session_state.last_msg)

if img_file:
    photo_id = img_file.name + str(img_file.size)
    if st.session_state.last_processed_photo != photo_id:
        img = PIL.Image.open(img_file)
        results = model(img, conf=0.5, verbose=False) 
        
        detected_this_turn = {}
        turn_points = 0

        for r in results:
            for c in r.boxes.cls:
                label = model.names[int(c)]
                category = label if label in SUSTAINABILITY_LOG else ("food" if label in FOOD_LABELS else None)
                if category:
                    st.session_state.counts[category] += 1
                    item_pts = SUSTAINABILITY_LOG[category]['points']
                    st.session_state.points = max(0, st.session_state.points + item_pts)
                    turn_points += item_pts
                    detected_this_turn[category] = detected_this_turn.get(category, 0) + 1
        
        st.session_state.last_processed_photo = photo_id

        if detected_this_turn:
            item_summaries = [f"{count}x {SUSTAINABILITY_LOG[cat]['name']}" for cat, count in detected_this_turn.items()]
            first_cat = list(detected_this_turn.keys())[0]
            target_bin = SUSTAINABILITY_LOG[first_cat]['bin']
            st.session_state.last_msg = f"âœ… Auto-Logged: {' & '.join(item_summaries)} (Use the {target_bin} bin)"

            if turn_points > 0:
                st.toast(f"Points Earned! +{turn_points} Pts", icon="ðŸŽ‰")
            if st.session_state.points > 0 and st.session_state.points % 100 == 0:
                st.toast("New Reward Unlocked!", icon="ðŸŽ")

            time.sleep(0.3)
            st.rerun()

# Sidebar
st.sidebar.header("DMU Campus ESG Report")

total_items = sum(st.session_state.counts.values())
purity_rate = (1 - (st.session_state.counts['cup'] / max(total_items, 1))) * 100

st.sidebar.metric("Batch Purity", f"{purity_rate:.1f}%")
st.sidebar.progress(purity_rate / 100)

st.sidebar.markdown("---")
st.sidebar.write(f"**Verified Points:** {st.session_state.points}")

progress_to_next_reward = (st.session_state.points % 100) / 100
discount_level = (st.session_state.points // 100) * 10

st.sidebar.write(f"**Progress to next 10% Discount:**")
st.sidebar.progress(progress_to_next_reward)
st.sidebar.success(f"ðŸŽ Current Reward: {discount_level}% Discount")

if st.sidebar.button("Reset Session Data"):
    st.session_state.counts = {"bottle": 0, "cup": 0, "can": 0, "food": 0}
    st.session_state.points = 0
    st.session_state.last_processed_photo = None
    st.session_state.last_msg = None
    st.rerun()

# Dashboard
st.markdown("---")
d_col1, d_col2, d_col3 = st.columns(3)
total_co2 = sum(st.session_state.counts[k] * SUSTAINABILITY_LOG[k]["co2_kg"] for k in st.session_state.counts)

d_col1.metric("CO2 Prevented", f"{total_co2:.2f} kg")
d_col2.metric("Est. Market Value", f"AED {(st.session_state.counts['can']*0.5 + st.session_state.counts['bottle']*0.1):.2f}")
d_col3.metric("Verified Points", f"{st.session_state.points} Pts")

st.write("### ðŸ“‹ DMU Dubai Waste Segregation Inventory")
st.table([{
    "Material Type": v["name"], 
    "Total Scanned": st.session_state.counts[k], 
    "Target Bin": v["bin"], 
    "Requirement": v["tip"]
} for k, v in SUSTAINABILITY_LOG.items()])

# Internal Validation
def generate_audit_hash(item_name, points):
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    raw_data = f"{timestamp}-{item_name}-{points}-DMU-DUBAI"
    return hashlib.sha256(raw_data.encode()).hexdigest()[:16]

st.markdown("---")
i_col1, i_col2 = st.columns(2)

with i_col1:
    st.write("### ðŸ›¡ï¸ Verifiable Audit Log")
    if total_items > 0:
        # Check if detected_this_turn exists in this rerun
        try:
            last_item = list(detected_this_turn.keys())[0] if detected_this_turn else "Session Active"
        except NameError:
            last_item = "Session Active"
            
        current_hash = generate_audit_hash(last_item, st.session_state.points)
        st.code(f"Current Block Hash: {current_hash}\nNode: DMU-DXB-MAIN-01\nStatus: VERIFIED", language="bash")

        audit_data = {
            "Timestamp": [datetime.now().strftime("%H:%M:%S")],
            "Total_CO2_kg": [total_co2],
            "Purity_Score": [purity_rate],
            "Verification_Hash": [current_hash]
        }
        df_audit = pd.DataFrame(audit_data)
        csv = df_audit.to_csv(index=False).encode('utf-8')

        st.download_button(
            label="ðŸ“¥ Download Audit-Ready Report",
            data=csv,
            file_name=f"DMU_ESG_Report_{datetime.now().strftime('%Y%m%d')}.csv",
            mime="text/csv",
            use_container_width=True
        )
    else:
        st.info("Awaiting first scan for verification...")

with i_col2:
    st.write("### ðŸŒ Real-World Impact")
    km_offset = total_co2 * 8.8 
    st.info(f"Your recycling efforts have offset the equivalent of driving **{km_offset:.2f} km** in a petrol car.")
    st.progress(min(purity_rate / 100, 1.0) if purity_rate >= 0 else 0.0)
